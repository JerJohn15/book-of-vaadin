<?xml version="1.0"?>

<project name="Vaadin Documentation" basedir="../" default="package-all">

    <target name="package-all" depends="clean-all, init, docs"/>

    <!-- Ant contrib required for flow control (for loop, if, property override) -->
    <taskdef resource="net/sf/antcontrib/antlib.xml">
        <classpath>
            <pathelement location="build/lib/ant-contrib-1.0b3.jar" />
        </classpath>
    </taskdef>

    <!-- ================================================================== -->
    <!-- Clean results                                                      -->
    <!-- ================================================================== -->
    <target name="clean-all" depends="">
        <property file="build/build.properties" />
        <delete dir="${result-path}" includes="**/*" followsymlinks="false" defaultexcludes="false" includeemptydirs="true" failonerror="false">
        </delete>
    </target>

    <!-- ================================================================== -->
    <!-- Initialization - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- ================================================================== -->

    <target name="init" depends="xep-license-check, xep-license-copy">

        <property file="build/build.properties" />
        <property file="build/VERSION.properties" />
        <property file="build/html-style.properties" />

        <!-- Can run XEP only if license is available. -->
        <available file="build/lib/XEP/license.xml" property="xep.license.available" />

        <!-- Create result dir unless already exists -->
        <mkdir dir="${result-path}" />

        <echo message="Prepared to build documentation for ${product-file} version ${version}" />

        <!-- Output directory -->
        <property name="output-dir" value="${result-path}/package" />
        <mkdir dir="${output-dir}" />

        <!-- Create Output Directory Hierarchy -->
        <mkdir dir="${output-dir}/WebContent" />
        <mkdir dir="${output-dir}/WebContent/docs" />
        <mkdir dir="${output-dir}/WebContent/docs/book" />

        <!-- Read the English book from the default directory, translations from prepared ones. -->
        <condition property="manual.source.dir" value="manual">
            <not><isset property="locale"/></not>
        </condition>
        <condition property="manual.source.dir" value="${result-path}/translations/${locale}">
            <isset property="locale"/>
        </condition>

        <!-- The language string for DocBook. -->
        <property name="manual.language.docbook" value="en"/>
        <property name="manual.language.extension" value=""/>

        <property name="manual.source.xml" value="${manual.source.dir}/book.xml"/>
        <echo>Manual source XML: ${manual.source.xml}</echo>
    </target>
    
    <target name="xep-license-check">
      <!-- Path to installed XEP license. -->
      <property name="xep.license.path.installed" value="/opt/RenderX/XEP/license.xml"/>
      <echo>XEP license expected to be installed as ${xep.license.path.installed}</echo>

      <!-- Can copy XEP license only if it is available. -->
      <available file="${xep.license.path.installed}" property="xep.license.installed"/>
    </target>

    <!-- If the XEP is installed, copy it to proper place. -->
    <target name="xep-license-copy" depends="xep-license-check" if="xep.license.installed">
        <copy file="${xep.license.path.installed}" todir="build/lib/XEP"/>
    </target>

    <!-- ================================================================== -->
    <!-- Build Documentation.                                               -->
    <!-- Not included: tutorial-pdf, tutorial-html                          -->
    <!-- ================================================================== -->
    <target name="docs" depends="manual-pdf, manual-html, package-docs"/>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- Package Documentation: Add documentation including style files      -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <target name="package-docs">
        <copy todir="${output-dir}/WebContent/docs/book/html-style">
            <fileset dir="manual/html-style">
                <exclude name="**/.svn" />
                <exclude name="**/test.html" />
            </fileset>
        </copy>
        <copy todir="${output-dir}/WebContent/docs">
            <fileset dir="/">
                <exclude name="**/.svn" />
                <include name="dtd/**/*.dtd" />
            </fileset>
        </copy>
    </target>

    <!-- ================================================================== -->
    <!-- Build Reference Manual.                                            -->
    <!-- ================================================================== -->

    <!-- Initialize properties especially for the Reference Manual. -->
    <target name="init-manual" depends="prepare-translations">
        <!-- Sets the current date as the publication date of the Manual. -->
        <tstamp>
            <format property="manual.pubdate" pattern="yyyy-MM-dd"/>
        </tstamp>

        <!-- Classpath for running the XSLT processor. -->
        <path id="docbook-xsl.classpath">
            <pathelement path="build/lib/fserializer.jar" />
            <pathelement path="build/lib/xalan.jar" />
            <pathelement path="build/lib/xercesImpl.jar" />
            <pathelement path="build/lib/xml-apis.jar" />
        </path>

		<condition property="locale.explicit" value="en_US">
			<not><isset property="locale"/></not>
		</condition>
		<property name="locale.explicit" value="${locale}"/>
		<echo>Locale: ${locale.explicit}</echo>
    </target>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- Build PDF manual                                                    -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <!-- Build PDF manual from sources or just copy it. -->
    <target name="manual-pdf" depends="init, xep-license-copy, init-manual, init-manual-pdf, build-manual-pdf, copy-manual-pdf">
    </target>

    <target name="init-manual-pdf" depends="">
        <!-- Detect the presense of Vaadin special fonts. -->
        <condition property="manual.fonts.custom" value="1" else="0">
            <available file="build/lib/XEP/fonts/HelveticaRoundedLTStd-Bd.otf" />
        </condition>

        <condition property="xep.config" value="build/lib/XEP/xep-vaadinfonts.xml" else="build/lib/XEP/xep.xml">
            <equals arg1="${manual.fonts.custom}" arg2="1"/>
        </condition>
    </target>

    <target name="modify-xep-config">
    </target>

    <!-- Just copy a prebuilt PDF manual. -->
    <target name="copy-manual-pdf" unless="xep.license.available">
        <echo>PDF Manual: No XEP license available, just copy a prebuilt PDF.</echo>
        <copy file="manual/book${manual.fo.style}.pdf" tofile="${output-dir}/WebContent/docs/book-of-vaadin.pdf" />
    </target>

    <!-- Build PDF manual with XEP FO processor. -->
    <target name="build-manual-pdf" depends="modify-xep-config" if="xep.license.available">
        <echo>PDF Manual: processing images (TBD)</echo>
        <!-- TBD -->
        <echo>PDF Manual: converting xml to fo</echo>

        <property name="manual.fo.style" value=""/>
		<property name="manual.fo.conf" value="custom-fo-docbook${manual.fo.style}.xsl"/>

        <echo>Configuration file: ${manual.fo.conf}</echo>

        <echo>Publication date is ${manual.pubdate}</echo>

        <java classname="org.apache.xalan.xslt.Process" failonerror="yes" fork="yes" maxmemory="512m">
            <arg value="-xsl" />
            <arg value="build/docbook/conf/${manual.fo.conf}" />
            <arg value="-in" />
            <arg value="${manual.source.xml}" />
            <arg value="-out" />
            <arg value="${result-path}/book${manual.language.extension}.fo" />
            <arg value="-param" />
            <arg value="section.autolabel" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="section.label.includes.component.label" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="section.autolabel.max.depth" />
            <arg value="2" />
            <arg value="-param" />
            <arg value="draft.watermark.image" />
            <arg value="''" />
            <arg value="-param" />
            <arg value="draft.mode" />
            <arg value="'no'" />
            <arg value="-param" />
            <arg value="double.sided" />
            <arg value="1" />
            <arg value="-param" /> <!-- PDF bookmarks support. -->
            <arg value="xep.extensions" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="manual.pubdate" />
            <arg value="${manual.pubdate}" />
            <arg value="-param" />
            <arg value="manual.version" />
            <arg value="${version}" />
            <arg value="-param" />
            <arg value="manual.fonts.custom" />
            <arg value="${manual.fonts.custom}" />
            <arg value="-param" />
            <arg value="l10n.gentext.language" />
            <arg value="${manual.language.docbook}" />
            <classpath refid="docbook-xsl.classpath" />
        </java>

        <echo>PDF Manual: converting FO to PDF</echo>
        <echo>Input: ${result-path}/book${manual.language.extension}.fo</echo>

        <!-- Run XEP FO processor to convert FO to PDF                  -->
        <!-- The processor fails in some cases if not run in Java 5 JRE -->
        <java classname="com.renderx.xep.XSLDriver"
            error="${result-path}/xep-error.log"
            failonerror="yes" fork="yes" maxmemory="512m"
            input="${result-path}/book${manual.language.extension}.fo"
            output="${output-dir}/WebContent/docs/book-of-vaadin${manual.language.extension}${manual.fo.style}.pdf">
            <arg value="-Dcom.renderx.xep.CONFIG=${xep.config}" />
            <classpath>
                <pathelement location="build/lib/XEP/lib/xep.jar" />
                <pathelement location="build/lib/XEP/lib/saxon.jar" />
                <pathelement location="build/lib/XEP/lib/xt.jar" />
            </classpath>
        </java>
    </target>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- HTML Manual                                                         -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <!-- Common initialization tasks for a HTML manual.                                   -->
    <!-- Some properties must be defined in the more specific HTML manual initialization. -->
    <target name="init-manual-html-common" depends="">
        <!-- Create the manual output directory if it doesn't already exist. -->
        <mkdir dir="${manual.html.output.dir}"/>

        <property name="manual.html.xsl.template"  value="build/docbook/conf/custom-html-template.xsl"/>
        <property name="manual.html.xsl.processed" value="build/docbook/conf/custom-html-processed.xsl"/>

        <!-- Replace tags in the HTML stylesheet template. -->
        <delete file="${manual.html.xsl.processed}" />
        <copy file="${manual.html.xsl.template}" tofile="${manual.html.xsl.processed}">
            <filterchain>
                <replacetokens>
                    <token key="BODYHEADER" value="${html.body.start1}${docbook.head.title}${html.body.start2}" />
                    <token key="BODYFOOTER" value="${html.body.end}" />
                </replacetokens>
            </filterchain>
        </copy>
    </target>

    <target name="manual-html-build" depends="init-manual-html-common">
        <echo>Building manual to ${manual.html.output.dir}</echo>
        <echo>Index file: ${manual.html.output.index}</echo>
        <java classname="org.apache.xalan.xslt.Process" failonerror="yes" fork="yes" maxmemory="512m">
            <arg value="-in" />
            <arg value="${manual.source.xml}" />
            <arg value="-xsl" />
            <arg value="${manual.html.xsl}" />
            <!-- The output file will be empty for eclipse plugin. -->
            <arg value="-out" />
            <arg value="${manual.html.output.index}" />
            <arg value="-param" />
            <arg value="section.autolabel" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="section.label.includes.component.label" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="section.autolabel.max.depth" />
            <arg value="2" />
            <arg value="-param" />
            <arg value="use.extensions" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="manual.pubdate" />
            <arg value="${manual.pubdate}" />
            <arg value="-param" />
            <arg value="manual.version" />
            <arg value="${version}" />
            <!-- This is needed only for the Eclipse Help plugin. -->
            <arg value="-param" />
            <arg value="eclipse.plugin.version" />
            <arg value="${eclipse.plugin.manual.version}" />
            <arg value="-param" />
            <arg value="l10n.gentext.language" />
            <arg value="${manual.language.docbook}" />
            <classpath refid="docbook-xsl.classpath" />
        </java>

        <delete file="${manual.html.xsl.processed}" />

        <!-- Copy images to output directory. -->
        <copy todir="${manual.html.output.dir}/img">
            <fileset dir="manual/img">
                <exclude name="**/.svn" />
            </fileset>
        </copy>
    </target>

    <!-- Configuration for building the HTML manual. -->
    <target name="init-manual-html" depends="init, init-manual">
        <property name="manual.html.xsl" value="build/docbook/conf/manual-html.xsl"/>
        <property name="manual.html.output.dir" value="${output-dir}/WebContent/docs/book${manual.language.extension}"/>
        <property name="manual.html.output.index" value="${manual.html.output.dir}/index.html"/>

        <echo>Manual: HTML</echo>
        <echo>Published: ${manual.pubdate}</echo>
	</target>

    <target name="manual-html" depends="init, init-manual, init-manual-html, init-manual-html-common, manual-html-build">
    </target>

    <!-- ant contrib required for flow control (for loop, if, property override) -->
    <taskdef resource="net/sf/antcontrib/antlib.xml">
        <classpath>
            <pathelement location="build/lib/ant-contrib-1.0b3.jar" />
        </classpath>
    </taskdef>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- EPub Manual                                                         -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <!-- Configuration for building the EPub manual. -->
    <target name="init-manual-epub" depends="init, init-manual">
        <property name="manual.html.xsl" value="build/docbook/conf/manual-epub.xsl"/>
        <property name="manual.html.output.dir" value="${output-dir}/WebContent/docs"/>
        <property name="manual.epub.output.filename" value="${manual.html.output.dir}/book-of-vaadin.epub"/>

        <echo>Manual: EPub</echo>
        <echo>Published: ${manual.pubdate}</echo>
	</target>

    <!-- Doesn't work at the moment -->
    <target name="manual-epub-xalan" depends="init, init-manual, init-manual-epub, init-manual-html-common, manual-html-build">
    </target>

    <!-- Uses a Ruby script for the EPUB transformation and packaging. -->
    <target name="manual-epub-ruby" depends="init, init-manual, init-manual-epub, init-manual-html-common">
        <exec executable="ruby" searchpath="true" resultproperty="publish.ssh.result">
            <arg value="build/docbook/xsl/epub/bin/dbtoepub"/>
            <arg value="-s"/>
            <arg value="${manual.html.xsl}"/>
            <arg value="-o"/>
            <arg value="${manual.epub.output.filename}"/>
            <arg value="manual/book.xml"/>
        </exec>

        <echo>EPUB manual written to ${manual.epub.output.filename}</echo>
    </target>

    <target name="manual-epub" depends="manual-epub-ruby">
    </target>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- Translations                                                        -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

	<target name="prepare-translations" if="locale">
        <mkdir dir="${manual.source.dir}"/>

		<!-- Copy English book on bottom. -->
		<copy todir="${manual.source.dir}">
			<fileset dir="manual">
				<include name="book.xml"/>
				<include name="book-info.xml"/>
				<include name="book-vol1.xml"/>
				<include name="book-vol2.xml"/>
				<include name="book-preface.xml"/>
				<include name="chapter*.xml"/>
				<include name="*.dtd"/>
				<include name="img/**/*.png"/>
				<include name="img/**/*.jpg"/>
			</fileset>
		</copy>

		<!-- Generate translated XML files from PO and English XML files. -->
        <!-- Execute the po2xml for each PO file for the locale -->
		<apply executable="po2xml" dest="." verbose="yes" force="yes">
            <!-- An execution gets the following parameters: -->
			<targetfile/> <!-- English XML file -->
			<srcfile/>    <!-- Translated PO file -->

            <!-- The translated PO files to be fed as srcfiles -->
			<fileset dir="${translation.staging.dir}">
				<include name="book.po"/>
				<include name="book-info.po"/>
				<include name="book-vol1.po"/>
				<include name="book-vol2.po"/>
				<include name="book-preface.po"/>
				<include name="chapter*.po"/>
			</fileset>

            <!-- Map the targetfile name from the srcfile name -->
			<globmapper from="*.po" to="manual/*.xml"/>

            <!-- Redirects stdout from po2xml to a file in the translated source dir -->
			<redirector>
				<outputmapper id="out" type="glob" from="*.po" to="${manual.source.dir}/*.xml"/>
			</redirector>
		</apply>
	</target>

	<!-- Compile localized documentation stored in repository. -->
	<target name="localized-docs">
		<antcall target="manual-pdf">
			<param name="locale" value="fi_FI"/>
			<param name="manual.language.docbook" value="fi"/>
			<param name="manual.language.extension" value="-fi"/>
		</antcall>
	</target>

    <!-- Download translations from the community translation service and build them. -->
    <target name="import-localized-docs" depends="init">
        <property name="manual.translations.importzip" value="${result-path}/book-of-vaadin-gl.zip"/>
        <property name="manual.translations.importdir" value="${result-path}/import"/>

        <!-- Download -->
        <exec executable="curl">
            <arg value="--user"/>
            <arg value="${getlocalization.username}:${getlocalization.password}"/>
            <arg value="${getlocalization.url}"/>
            <arg value="-o"/>
            <arg value="${manual.translations.importzip}"/>
        </exec>

        <unzip src="${manual.translations.importzip}" dest="${manual.translations.importdir}"/>
    </target>

    <!-- Stage imported locale to be built -->
	<target name="stage-imported-locale" depends="init">
        <property name="translation.import.dir" value="${result-path}/import/${manual.language.docbook}${import.language.extension}"/>
        <property name="translation.staging.dir" value="${result-path}/translation-staging/${locale}"/>

        <echo>Translation import dir:  ${translation.import.dir}</echo>
        <echo>Translation staging dir: ${translation.staging.dir}</echo>

        <mkdir dir="${translation.staging.dir}"/>

        <!-- Copy PO files from repository to the staging directory -->
        <!-- ...not, because we are going to merge them
        <copy todir="${translation.staging.dir}" overwrite="yes" failonerror="no">
            <fileset dir="manual/translations/${locale}">
                <include name="*.po"/>
            </fileset>
        </copy>
        -->

        <!-- Copy imported translations over the existing PO files  -->
        <!--  * Remove locale from the filenames                    -->
        <!--  * Unify different filename extensions to .po          -->
        <copy todir="${translation.staging.dir}" overwrite="yes" failonerror="no">
            <fileset dir="${translation.import.dir}">
                <include name="*.po"/>
            </fileset>
            <globmapper from="*_${manual.language.docbook}${import.language.extension}.po" to="*.po"/>
        </copy>

        <copy todir="${translation.staging.dir}" overwrite="yes" failonerror="no">
            <fileset dir="${translation.import.dir}">
                <include name="*.pot"/>
            </fileset>
            <globmapper from="*_${manual.language.docbook}${import.language.extension}.pot" to="*.po"/>
        </copy>
    </target>

	<!-- Merge new strings in templates to an existing translation. -->
	<target name="merge-imported-locale" depends="init,stage-imported-locale">
        <apply executable="msgmerge">
            <arg value="--no-wrap"/>
            <arg value="-U"/>
            <targetfile/>
            <srcfile/>
            <fileset dir="manual/translations/pot">
                <include name="*.pot"/>
            </fileset>
            <globmapper from="*.pot" to="../${translation.staging.dir}/*.po"/>
        </apply>
    </target>

	<!-- Compile imported localized documentation. -->
	<target name="build-imported-locale" depends="init, stage-imported-locale">
		<antcall target="manual-html" inheritAll="false">
			<param name="locale" value="${locale}"/>
			<param name="manual.language.docbook" value="${manual.language.docbook}"/>
			<param name="manual.language.extension" value="${manual.language.extension}"/>
			<param name="translation.staging.dir" value="${translation.staging.dir}"/>
		</antcall>

		<antcall target="manual-pdf" inheritAll="false">
			<param name="locale" value="${locale}"/>
			<param name="manual.language.docbook" value="${manual.language.docbook}"/>
			<param name="manual.language.extension" value="${manual.language.extension}"/>
			<param name="translation.staging.dir" value="${translation.staging.dir}"/>
		</antcall>
	</target>

    <target name="merge-all-localized-docs">
        <!-- Run the build for each language. -->
        <antcall target="merge-imported-locale" inheritAll="false">
            <param name="locale" value="fi_FI"/>
			<param name="manual.language.docbook" value="fi"/>
			<param name="import.language.extension" value=""/>
			<param name="manual.language.extension" value="-fi"/>
        </antcall>
    </target>

    <target name="build-all-localized-docs">
        <!-- Run the build for each language. -->
        <antcall target="build-imported-locale" inheritAll="false">
            <param name="locale" value="fi_FI"/>
			<param name="manual.language.docbook" value="fi"/>
			<param name="import.language.extension" value=""/>
			<param name="manual.language.extension" value="-fi"/>
        </antcall>

        <antcall target="build-imported-locale" inheritAll="false">
            <param name="locale" value="pt_BR"/>
			<param name="manual.language.docbook" value="pt"/>
			<param name="import.language.extension" value="-BR"/>
			<param name="manual.language.extension" value="-br"/>
        </antcall>

        <!--
        <antcall target="build-imported-locale" inheritAll="false">
            <param name="locale" value="de_DE"/>
			<param name="manual.language.docbook" value="de"/>
			<param name="import.language.extension" value=""/>
			<param name="manual.language.extension" value="-de"/>
        </antcall>

        <antcall target="build-imported-locale" inheritAll="false">
            <param name="locale" value="fr_FR"/>
			<param name="manual.language.docbook" value="fr"/>
			<param name="import.language.extension" value=""/>
			<param name="manual.language.extension" value="-fr"/>
        </antcall>

        <antcall target="build-imported-locale" inheritAll="false">
            <param name="locale" value="cs_CZ"/>
			<param name="manual.language.docbook" value="cs"/>
			<param name="import.language.extension" value="-CZ"/>
			<param name="manual.language.extension" value="-cs"/>
        </antcall>

        <antcall target="build-imported-locale" inheritAll="false">
            <param name="locale" value="zh_CN"/>
			<param name="manual.language.docbook" value="zh"/>
			<param name="import.language.extension" value="-CN"/>
			<param name="manual.language.extension" value="-cn"/>
        </antcall>

        <antcall target="build-imported-locale" inheritAll="false">
            <param name="locale" value="es_419"/>
			<param name="manual.language.docbook" value="es"/>
			<param name="import.language.extension" value="-419"/>
			<param name="manual.language.extension" value="-es"/>
        </antcall>

        <antcall target="build-imported-locale" inheritAll="false">
            <param name="locale" value="ru_RU"/>
			<param name="manual.language.docbook" value="ru"/>
			<param name="import.language.extension" value=""/>
			<param name="manual.language.extension" value="-ru"/>
        </antcall>
        -->
    </target>

    <target name="publish-localized-docs" depends="init">
        <property name="manual.translations.zip" value="${result-path}/book-of-vaadin-translations.zip"/>
        
        <!-- Package all translations -->
        <zip zipfile="${manual.translations.zip}"
             basedir="${result-path}/package/WebContent/docs/">
           <include name="book-??/**/*"/>
           <include name="book-*.pdf"/>
        </zip>

        <!-- Publish to download site -->
        <!-- Copy the linux installation package and the JAR. -->
        <echo>Copying package to server...</echo>
        <exec executable="scp" searchpath="true" resultproperty="publish.scp.result">
            <arg value="-B"/>
            <arg value="${manual.translations.zip}"/>
            <arg value="${manual.publish}"/>
        </exec>

        <!-- Unpackage the documentation on the target server. -->
        <echo>Extracting package on server...</echo>
        <exec executable="ssh" searchpath="true" resultproperty="publish.ssh.result">
            <arg value="${manual.publish.address}"/>
            <arg value="${manual.publish.script}"/>
        </exec>
    </target>

    <target name="filter-localized-docs" depends="init">
        <property name="manual.translations.importzip" value="${result-path}/book-of-vaadin-gl.zip"/>
        <property name="manual.translations.importdir" value="${result-path}/import"/>

        <!-- Download -->
        <exec executable="curl">
            <arg value="--user"/>
            <arg value="${getlocalization.username}:${getlocalization.password}"/>
            <arg value="${getlocalization.url}"/>
            <arg value="-o"/>
            <arg value="${manual.translations.importzip}"/>
        </exec>

        <unzip src="${manual.translations.importzip}" dest="${manual.translations.importdir}"/>
        <!-- https://www.getlocalization.com/[projekti]/api/profile/[username]/json/ -->
    </target>

    <!-- =================================================================== -->
    <!-- Eclipse Manual                                                      -->
    <!-- =================================================================== -->
    <!-- Note: The Eclipse Manual must not be built in the same build        -->
    <!--       as the HTML manual (manual-html-build), as it reuses the      -->
    <!--       same build target with different parameters.                  -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <target name="init-manual-eclipse" depends="">
        <!-- Timestamp in YYYYMMDDHHMM format for plugin version number. -->
        <tstamp>
            <format property="eclipse.plugin.manual.pubtime" pattern="yyyyMMddkkmm"/>
        </tstamp>

        <property name="eclipse.plugin.manual.version" value="${version}.${eclipse.plugin.manual.pubtime}" />
        <echo>Manual: Eclipse Help Plugin (version ${eclipse.plugin.manual.version})</echo>

        <property name="manual.html.xsl" value="build/docbook/conf/manual-eclipse-plugin.xsl"/>
        <property name="manual.html.output.dir" value="${output-dir}/WebContent/docs/eclipse"/>
        <property name="manual.html.output.index" value="${manual.html.output.dir}/index-eclipse.html"/>

        <property name="output-dir-manual" value="${output-dir}/WebContent/docs/book" />
    </target>

    <!-- Builds Eclipse Help plugin. Uses the manual-html-build target  -->
    <!-- to build the HTML content of the manual.                       -->
    <target name="manual-eclipse-plugin" depends="init, init-manual, init-manual-eclipse, init-manual-html-common, manual-html-build">
        <!-- Plugin JAR filename -->
        <property name="eclipse.plugin.manual.jar-name"
                 value="com.vaadin.manual_${eclipse.plugin.manual.version}.jar" />

        <!-- Package the JAR. -->
    	<mkdir dir="${output-dir}/eclipse"/>
    	<mkdir dir="${output-dir}/eclipse/plugins"/>
        <jar jarfile="${output-dir}/eclipse/plugins/${eclipse.plugin.manual.jar-name}" compress="true">
            <fileset dir="${manual.html.output.dir}">
                <patternset>
                    <include name="**/*" />

                    <!-- The index file is empty. -->
                    <exclude name="index-eclipse.html"/>
                </patternset>
            </fileset>
            <manifest>
                <attribute name="Built-By" value="${user.name}"/>
                <attribute name="Bundle-Name" value="Book of Vaadin"/>
                <attribute name="Bundle-SymbolicName" value="com.vaadin.manual"/>
                <attribute name="Bundle-Version" value="${eclipse.plugin.manual.version}"/>
                <attribute name="Bundle-Vendor" value="Vaadin Ltd."/>
            </manifest>
        </jar>
    </target>

	<!-- Packages the plugin as a "feature" plugin in Eclipse. -->
	<target name="manual-eclipse-feature">
		<property name="manual.eclipse.feature.dir" value="${output-dir}/feature"/>

        <!-- Plugin JAR filename -->
        <property name="eclipse.manual.feature.jar"
                 value="com.vaadin.integration.eclipse.manual_${eclipse.plugin.manual.version}.jar" />

		<!-- Fill out the feature.xml template. -->
		<copy file="build/feature.xml.tpl" tofile="${output-dir}/feature.xml" overwrite="true">
			<filterchain>
				<replacetokens begintoken="@" endtoken="@">
					<token key="manual-version" value="${eclipse.plugin.manual.version}" />
				</replacetokens>
				<replacetokens begintoken="@" endtoken="@">
					<token key="vaadin-version" value="${version}" />
				</replacetokens>
			</filterchain>
		</copy>
		
		<echo>Build:   ${output-dir}/${eclipse.manual.feature.jar}</echo>
		<echo>Include: ${output-dir}/${eclipse.plugin.manual.jar-name}</echo>
		<echo>Include: ${output-dir}/feature.xml</echo>
    	<mkdir dir="${output-dir}/eclipse"/>
    	<mkdir dir="${output-dir}/eclipse/features"/>
		<jar destfile="${output-dir}/eclipse/features/${eclipse.manual.feature.jar}" compress="true">
			<fileset dir="${output-dir}">
				<include name="feature.xml"/>
			</fileset>
            <manifest>
                <attribute name="Built-By" value="${user.name}"/>
                <attribute name="Bundle-Name" value="Book of Vaadin"/>
                <attribute name="Bundle-SymbolicName" value="com.vaadin.integration.eclipse.manual"/>
                <attribute name="Bundle-Version" value="${eclipse.plugin.manual.version}"/>
                <attribute name="Bundle-Vendor" value="Vaadin Ltd."/>
            </manifest>
		</jar>
	</target>

    <!-- Sign resulting plugin and feature -->
    <target name="sign-plugin-and-feature" if="jarsigner.bin">
        <!-- Sign the plugin -->
        <exec executable="${jarsigner.bin}">
            <arg path="${output-dir}/eclipse/plugins/${eclipse.plugin.manual.jar-name}" />
        </exec>

        <!-- Sign the feature -->
        <exec executable="${jarsigner.bin}">
            <arg path="${output-dir}/eclipse/features/${eclipse.manual.feature.jar}" />
        </exec>
    </target>

	<target name="manual-eclipse" depends="manual-eclipse-plugin, manual-eclipse-feature, sign-plugin-and-feature">
		<echo>##teamcity[publishArtifacts '${output-dir}/eclipse/**/*.jar']</echo>
	</target>

    <!-- ================================================================== -->
    <!-- Application Tutorial.                                              -->
    <!-- ================================================================== -->

    <!-- Initialize properties especially for the Reference Tutorial. -->
    <target name="init-tutorial" depends="">
        <!-- Sets the current date as the publication date of the Tutorial. -->
        <tstamp>
            <format property="tutorial.pubdate" pattern="yyyy-MM-dd"/>
        </tstamp>

        <mkdir dir="${output-dir}/WebContent/docs/tutorial" />
    </target>

    <!-- Build PDF tutorial from sources or just copy it. -->
    <target name="tutorial-pdf" depends="init, xep-license-copy, init-tutorial, build-tutorial-pdf, copy-tutorial-pdf">
    </target>

    <!-- Just copy a prebuilt PDF tutorial. -->
    <target name="copy-tutorial-pdf" unless="xep.license.available">
        <echo>PDF Tutorial: No XEP license available, just copy a prebuilt PDF.</echo>
        <copy file="tutorial/vaadin-tutorial.pdf" tofile="${output-dir}/WebContent/docs/vaadin-tutorial.pdf" />
    </target>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- Build PDF tutorial with XEP FO processor                            -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <target name="build-tutorial-pdf" if="xep.license.available">
        <echo>PDF Tutorial: processing images (TBD)</echo>
        <!-- TBD -->
        <echo>PDF Tutorial: converting xml to fo</echo>

        <echo>Publication date is ${tutorial.pubdate}</echo>

        <java classname="org.apache.xalan.xslt.Process" failonerror="yes" fork="yes" maxmemory="512m">
            <arg value="-xsl" />
            <arg value="build/docbook/conf/custom-fo-docbook.xsl" />
            <arg value="-in" />
            <arg value="tutorial/tutorial.xml" />
            <arg value="-out" />
            <arg value="${result-path}/vaadin-tutorial.fo" />
            <arg value="-param" />
            <arg value="section.autolabel" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="section.label.includes.component.label" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="section.autolabel.max.depth" />
            <arg value="2" />
            <arg value="-param" />
            <arg value="draft.watermark.image" />
            <arg value="''" />
            <arg value="-param" />
            <arg value="draft.mode" />
            <arg value="'no'" />
            <arg value="-param" />
            <arg value="double.sided" />
            <arg value="1" />
            <arg value="-param" /> <!-- PDF bookmarks support. -->
            <arg value="xep.extensions" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="manual.pubdate" />
            <arg value="${tutorial.pubdate}" />
            <arg value="-param" />
            <arg value="manual.version" />
            <arg value="${version}" />
            <classpath>
                <pathelement location="build/lib/xalan.jar" />
                <pathelement location="build/lib/xercesImpl.jar" />
                <pathelement location="build/lib/xml-apis.jar" />
            </classpath>
        </java>
        <echo>PDF Tutorial: converting fo to pdf</echo>
        <!-- Run XEP FO processor to convert FO to PDF -->
        <java classname="com.renderx.xep.XSLDriver" error="${result-path}/xep-error.log" failonerror="yes" fork="yes" maxmemory="512m" input="${result-path}/vaadin-tutorial.fo" output="${output-dir}/WebContent/docs/vaadin-tutorial.pdf">
            <arg value="-Dcom.renderx.xep.CONFIG=build/lib/XEP/xep.xml" />
            <classpath>
                <pathelement location="build/lib/XEP/lib/tools.jar" />
                <pathelement location="build/lib/XEP/lib/xep.jar" />
                <pathelement location="build/lib/XEP/lib/saxon.jar" />
                <pathelement location="build/lib/XEP/lib/xt.jar" />
            </classpath>
        </java>
    </target>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- HTML Tutorial                                                       -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <target name="tutorial-html" depends="init, init-tutorial">
        <echo>Tutorial: HTML</echo>
        <echo>Publication date is ${tutorial.pubdate}</echo>

        <delete file="build/docbook/conf/temp.xsl" />
        <copy file="build/docbook/conf/custom-html-docbook.xsl" tofile="build/docbook/conf/temp.xsl">
            <filterchain>
                <replacetokens>
                    <token key="BODYHEADER" value="${html.body.start1}${docbook.head.title}${html.body.start2}" />
                     <token key="BODYFOOTER" value="${html.body.end}" />
                </replacetokens>
            </filterchain>
        </copy>
        <path id="docbook-xsl.classpath">
            <pathelement path="build/lib/fserializer.jar" />
            <pathelement path="build/lib/xalan.jar" />
            <pathelement path="build/lib/xercesImpl.jar" />
            <pathelement path="build/lib/xml-apis.jar" />
        </path>
        <java classname="org.apache.xalan.xslt.Process" failonerror="yes" fork="yes" maxmemory="512m">
            <arg value="-in" />
            <arg value="tutorial/tutorial.xml" />
            <arg value="-xsl" />
            <arg value="build/docbook/conf/temp.xsl" />
            <arg value="-out" />
            <arg value="${output-dir}/WebContent/docs/tutorial/index.html" />
            <arg value="-param" />
            <arg value="section.autolabel" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="section.label.includes.component.label" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="section.autolabel.max.depth" />
            <arg value="2" />
            <arg value="-param" />
            <arg value="use.extensions" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="manual.pubdate" />
            <arg value="${tutorial.pubdate}" />
            <arg value="-param" />
            <arg value="manual.version" />
            <arg value="${version}" />
            <classpath refid="docbook-xsl.classpath" />
        </java>
        <delete file="build/docbook/conf/temp.xsl" />

		<!-- Copy images. -->
        <copy todir="${output-dir}/WebContent/docs/tutorial/img">
            <fileset dir="tutorial/img">
                <exclude name="**/.svn" />
            </fileset>
        </copy>
    </target>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- Targets for the SQLContainer Tutorial                               -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <target name="init-sqltutorial" depends="">
        <!-- Sets the current date as the publication date of the Tutorial. -->
        <tstamp>
            <format property="tutorial.pubdate" pattern="yyyy-MM-dd"/>
        </tstamp>
        <property name="sqlcontainer-version" value="1.0" />

        <mkdir dir="${output-dir}/WebContent/docs/sqltutorial" />
    </target>
    
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- HTML Version of the SQLContainer Tutorial                           -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <target name="sqltutorial-html" depends="init, init-sqltutorial">
        <echo>SQLContainer Tutorial: HTML</echo>
        <echo>Publication date is ${tutorial.pubdate}</echo>

        <delete file="build/docbook/conf/temp.xsl" />
        <copy file="build/docbook/conf/custom-html-docbook.xsl" tofile="build/docbook/conf/temp.xsl">
            <filterchain>
                <replacetokens>
                    <token key="BODYHEADER" value="${html.body.start1}${docbook.head.title}${html.body.start2}" />
                     <token key="BODYFOOTER" value="${html.body.end}" />
                </replacetokens>
            </filterchain>
        </copy>
        <path id="docbook-xsl.classpath">
            <pathelement path="build/lib/fserializer.jar" />
            <pathelement path="build/lib/xalan.jar" />
            <pathelement path="build/lib/xercesImpl.jar" />
            <pathelement path="build/lib/xml-apis.jar" />
        </path>
        <java classname="org.apache.xalan.xslt.Process" failonerror="yes" fork="yes" maxmemory="512m">
            <arg value="-in" />
            <arg value="tutorial/SQLContainer/tutorial.xml" />
            <arg value="-xsl" />
            <arg value="build/docbook/conf/temp.xsl" />
            <arg value="-out" />
            <arg value="${output-dir}/WebContent/docs/sqltutorial/index.html" />
            <arg value="-param" />
            <arg value="section.autolabel" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="section.label.includes.component.label" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="section.autolabel.max.depth" />
            <arg value="2" />
            <arg value="-param" />
            <arg value="use.extensions" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="manual.pubdate" />
            <arg value="${tutorial.pubdate}" />
            <arg value="-param" />
            <arg value="manual.version" />
            <arg value="${sqlcontainer-version}" />
            <classpath refid="docbook-xsl.classpath" />
        </java>
        <delete file="build/docbook/conf/temp.xsl" />
    </target>

    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <!-- Build PDF tutorial with XEP FO processor                            -->
    <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
    <target name="build-sqltutorial-pdf" if="xep.license.available">
        <echo>PDF Tutorial: processing images (TBD)</echo>
        <!-- TBD -->
        <echo>PDF Tutorial: converting xml to fo</echo>

        <echo>Publication date is ${tutorial.pubdate}</echo>

        <java classname="org.apache.xalan.xslt.Process" failonerror="yes" fork="yes" maxmemory="512m">
            <arg value="-xsl" />
            <arg value="build/docbook/conf/custom-fo-docbook.xsl" />
            <arg value="-in" />
            <arg value="tutorial/SQLContainer/tutorial.xml" />
            <arg value="-out" />
            <arg value="${result-path}/vaadin-sqltutorial.fo" />
            <arg value="-param" />
            <arg value="section.autolabel" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="section.label.includes.component.label" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="section.autolabel.max.depth" />
            <arg value="2" />
            <arg value="-param" />
            <arg value="draft.watermark.image" />
            <arg value="''" />
            <arg value="-param" />
            <arg value="draft.mode" />
            <arg value="'no'" />
            <arg value="-param" />
            <arg value="double.sided" />
            <arg value="1" />
            <arg value="-param" /> <!-- PDF bookmarks support. -->
            <arg value="xep.extensions" />
            <arg value="1" />
            <arg value="-param" />
            <arg value="manual.pubdate" />
            <arg value="${tutorial.pubdate}" />
            <arg value="-param" />
            <arg value="manual.version" />
            <arg value="${sqlcontainer-version}" />
            <classpath>
                <pathelement location="build/lib/xalan.jar" />
                <pathelement location="build/lib/xercesImpl.jar" />
                <pathelement location="build/lib/xml-apis.jar" />
            </classpath>
        </java>
        <echo>PDF Tutorial: converting fo to pdf</echo>
        <!-- Run XEP FO processor to convert FO to PDF -->
        <java classname="com.renderx.xep.XSLDriver" error="${result-path}/xep-error.log" failonerror="yes" fork="yes" maxmemory="512m" input="${result-path}/vaadin-sqltutorial.fo" output="${output-dir}/WebContent/docs/vaadin-sqlcontainer-tutorial.pdf">
            <arg value="-Dcom.renderx.xep.CONFIG=build/lib/XEP/xep.xml" />
            <classpath>
                <pathelement location="build/lib/XEP/lib/tools.jar" />
                <pathelement location="build/lib/XEP/lib/xep.jar" />
                <pathelement location="build/lib/XEP/lib/saxon.jar" />
                <pathelement location="build/lib/XEP/lib/xt.jar" />
            </classpath>
        </java>
    </target>

    <!-- Build PDF tutorial from sources or just copy it. -->
    <target name="sqltutorial-pdf" depends="xep-license-copy, init, init-sqltutorial, build-sqltutorial-pdf">
    </target>

    <!-- Packages the HTML files to a Zip package -->
    <target name="zip-all" depends="init, init-manual-html">
        <property name="manual.package.zip" value="${result-path}/book-of-vaadin.zip"/>
        <echo>Packaging HTML: ${manual.package.zip}</echo>

        <zip zipfile="${manual.package.zip}">
            <zipfileset prefix="html" dir="${manual.html.output.dir}">
                <patternset>
                    <include name="**/*" />
                </patternset>
            </zipfileset>

            <!-- <zipfileset prefix="tutorial" dir="${output-dir}/WebContent/docs/tutorial/">
                <patternset>
                    <include name="**/*" />
                </patternset>
            </zipfileset> -->

            <zipfileset prefix="pdf" dir="${output-dir}/WebContent/docs/">
                <patternset>
                    <include name="*.pdf" />
                </patternset>
            </zipfileset>
        </zip>
    </target>

    <!-- Publishes the book in the web server -->
    <target name="publish" depends="init, zip-all">
    	<fail unless="manual.publish" message="Manual publish target must be defined in manual.publish"/>

        <!-- Copy the linux installation package and the JAR. -->
        <echo>Copying package to server...</echo>
        <exec executable="scp" searchpath="true" resultproperty="publish.scp.result">
            <arg value="-B"/>
            <arg value="${manual.package.zip}"/>
            <arg value="${manual.publish}"/>
        </exec>

        <!-- Unpackage the documentation on the target server. -->
        <echo>Extracting package on server...</echo>
        <exec executable="ssh" searchpath="true" resultproperty="publish.ssh.result">
            <arg value="${manual.publish.address}"/>
            <arg value="${manual.publish.script}"/>
        </exec>
    </target>
</project>

<!-- Keep this comment at the end of the file
Local variables:
mode: xml
sgml-omittag:nil
sgml-shorttag:nil
sgml-namecase-general:nil
sgml-general-insert-case:lower
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:4
sgml-indent-data:t
sgml-parent-document:nil
sgml-exposed-tags:nil
sgml-local-catalogs:("/etc/sgml/catalog" "/usr/share/xemacs21/xemacs-packages/etc/psgml-dtds/CATALOG")
sgml-local-ecat-files:("ECAT" "~/sgml/ECAT" "/usr/share/sgml/ECAT" "/usr/local/share/sgml/ECAT" "/usr/local/lib/sgml/ECAT")
End:
-->
